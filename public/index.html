<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ultar WBD Console</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Base styles */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: #1c1c1e;
            color: #f1f1f1;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            text-align: center;
        }

        /* Variables */
        :root {
            --bg-primary: #1c1c1e;
            --bg-secondary: #2c2c2e;
            --bg-tertiary: #3a3a3c;
            --text-primary: #ffffff;
            --text-secondary: #8e8e93;
            --accent-cyan: #00FFD1; /* Neon Cyan */
            --accent-blue: #0a84ff;
            --status-online: #34c759;
            --status-offline: #ff3b30;
            --status-warning: #ffcc00;
        }

        #app {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            text-align: left;
            flex: 1;
        }
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 16px 0;
        }

        /* Header */
        .header {
            border-bottom: 1px solid var(--bg-tertiary);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            margin-bottom: 10px;
        }

        .header-title {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--text-primary);
            flex: 1;
            text-align: center;
        }

        .header-back {
            background: none;
            border: none;
            color: var(--accent-cyan);
            font-size: 20px;
            cursor: pointer;
            padding: 4px 8px;
            flex-shrink: 0;
            margin-left: -10px;
        }

        /* Bot List & Cards */
        .bot-list { display: flex; flex-direction: column; gap: 12px; }
        .bot-card, .management-option {
            background-color: var(--bg-secondary);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s ease, background-color 0.2s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 12px;
        }
        .bot-card:active { transform: translateY(-2px); background-color: var(--bg-tertiary); }
        .bot-icon-circle {
            width: 40px; height: 40px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5em; font-weight: bold; color: var(--text-primary);
        }
        .bot-details { display: flex; flex-direction: column; flex-grow: 1; }
        .bot-name { font-size: 1.1em; font-weight: 600; }
        .bot-username { font-size: 0.9em; color: var(--text-secondary); }
        .status-tag { 
            padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 0.75em;
            text-transform: uppercase; margin-left: 8px;
        }
        
        /* Status Colors */
        .bg-green { background-color: var(--status-online); color: var(--bg-secondary); }
        .bg-red { background-color: var(--status-offline); color: var(--text-primary); }
        .bg-yellow { background-color: var(--status-warning); color: var(--bg-secondary); }
        
        /* Management View */
        .action-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px; }
        .action-button {
            padding: 12px 0; border-radius: 10px; border: none;
            background-color: var(--bg-tertiary); color: var(--text-primary);
            font-weight: 600; cursor: pointer; transition: background-color 0.2s ease;
        }
        .action-button:active { background-color: #48484a; }
        .action-button.danger { background-color: #ef4444; }

        /* Variable Modal */
        .variable-item {
            background: var(--bg-tertiary); border-radius: 10px; padding: 12px;
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer;
        }
        .variable-name { color: var(--accent-cyan); font-weight: 600; }
        .variable-value { font-size: 0.9em; color: var(--text-secondary); word-break: break-all; }

        /* Input Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7); display: none; align-items: flex-end; z-index: 1000;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--bg-secondary); border-radius: 20px 20px 0 0;
            padding: 20px; width: 100%; max-height: 90vh; overflow-y: auto;
        }
        .modal-header { padding-bottom: 16px; border-bottom: 1px solid var(--bg-tertiary); margin-bottom: 16px; }
        .modal-title { font-size: 18px; font-weight: 600; }
        .modal-close { background: none; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer; }
        
        .input-field {
            width: 100%; padding: 12px; border-radius: 10px;
            border: 1px solid var(--border-color); background: var(--bg-tertiary);
            color: var(--text-primary); margin-bottom: 10px;
        }
        .btn { padding: 12px; border-radius: 10px; border: none; background-color: var(--accent-cyan); color: #000; font-weight: 600; cursor: pointer; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); }

        /* Utilities */
        .loading-text { text-align: center; color: var(--text-secondary); padding: 20px; }
    </style>
</head>
<body>
    <div id="app">
        <!-- Header -->
        <div class="header">
            <button class="header-back" id="headerBack" style="display: none;">←</button>
            <div class="header-title" id="headerTitle">Bot Console</div>
            <div style="width: 24px;"></div>
        </div>

        <!-- Content Area -->
        <div class="content">
            <!-- View 1: My Bots List -->
            <div class="view active" id="myBotsView">
                <div id="botsListContainer" class="bot-list">
                    <div id="loadingIndicator" class="loading-text">
                        <div class="loading"></div> Fetching active bots...
                    </div>
                </div>
            </div>

            <!-- View 2: Bot Management -->
            <div class="view" id="managementView">
                <div class="management-header">
                    <div class="management-bot-name" id="managementBotName"></div>
                    <div class="management-description" id="managementBotStatus">Status: Loading</div>
                </div>
                <div class="action-buttons-group" id="actionButtonsContainer"></div>
            </div>

            <!-- View 3: Variables List -->
            <div class="view" id="variablesView">
                <div class="modal-title" style="margin-bottom: 16px;" id="variablesBotName">Bot Variables</div>
                <div id="variablesListContainer" class="variables-list"></div>
            </div>
        </div>
    </div>

    <!-- Variables Modal -->
    <div class="modal-overlay" id="variablesModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Set Variables</div>
                <button class="modal-close" onclick="closeModal('variablesModal')">×</button>
            </div>
            <div class="variables-list" id="variablesList"></div>
        </div>
    </div>

    <!-- Input Variable Modal -->
    <div class="confirmation-dialog" id="inputVariableModal">
        <div class="confirmation-message">
             <div style="font-weight: 600;" id="inputModalTitle">Edit Variable</div>
             <div style="font-size: 0.8em; color: var(--text-secondary);" id="inputVarLabel"></div>
        </div>
        <div class="input-modal">
            <input type="text" class="input-field" id="inputVariableValue" placeholder="Enter new value">
            <div class="input-error" id="inputError" style="display: none;"></div>
            <button class="btn" onclick="submitVariableChange()">Save Variable</button>
            <button class="btn btn-secondary" onclick="closeModal('inputVariableModal')">Cancel</button>
        </div>
    </div>

    <!-- Logs Modal -->
    <div class="modal-overlay" id="logsModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Bot Logs</div>
                <button class="modal-close" onclick="closeModal('logsModal')">×</button>
            </div>
            <div class="logs-container" id="logsContainer">
                <div class="log-line">Fetching real-time logs...</div>
            </div>
        </div>
    </div>

    <!-- Confirmation Dialog -->
    <div class="confirmation-dialog" id="confirmationDialog">
        <div class="confirmation-message" id="confirmationMessage">Are you sure?</div>
        <div class="confirmation-buttons">
            <button class="confirmation-btn cancel" onclick="cancelConfirmation()">Cancel</button>
            <button class="confirmation-btn confirm" id="confirmationConfirmBtn" onclick="confirmAction()">Confirm</button>
        </div>
    </div>

    <script>
        // --- Global Config & State ---
        let currentBot = null;
        let pendingConfirmation = null;
        let currentVariable = { name: null, value: null };
        const apiBaseUrl = window.location.origin + '/api'; 
        const tg = window.Telegram.WebApp;
        tg.ready();

        // Utility Functions
        function showAlert(message) { tg.showAlert(message); }
        function showProgress(show) { show ? tg.showProgress(true) : tg.hideProgress(); }

        function showConfirm(message, onConfirm, destructive = false) {
            const dialog = document.getElementById('confirmationDialog');
            document.getElementById('confirmationMessage').textContent = message;
            
            const confirmBtn = document.getElementById('confirmationConfirmBtn');
            confirmBtn.classList.toggle('destructive', destructive);
            
            pendingConfirmation = { onConfirm };
            dialog.classList.add('active');
        }

        function confirmAction() {
            document.getElementById('confirmationDialog').classList.remove('active');
            if (pendingConfirmation && pendingConfirmation.onConfirm) {
                pendingConfirmation.onConfirm();
            }
            pendingConfirmation = null;
        }

        function cancelConfirmation() {
            document.getElementById('confirmationDialog').classList.remove('active');
            pendingConfirmation = null;
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // --- View Routing ---
        function switchView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');

            const isManagementView = viewId === 'managementView' || viewId === 'variablesView';
            
            // Update Header Display
            document.getElementById('headerTitle').textContent = isManagementView ? currentBot?.name : 'My Bots';
            document.getElementById('headerBack').style.display = isManagementView ? 'block' : 'none';
        }

        // --- Component Render Logic ---
        
        // Helper to format expiration date
        function formatExpiration(dateStr) {
            const expiration = new Date(dateStr);
            const diffDays = Math.ceil((expiration.getTime() - Date.now()) / (1000 * 60 * 60 * 24));
            if (diffDays <= 0) return 'Expired';
            if (diffDays < 30) return `Expires in ${diffDays}d`;
            return `Expires ${expiration.toLocaleDateString()}`;
        }

        // Helper to get color/class based on status text
        const getStatusData = (status) => {
            if (status === 'Online') return { color: '#34c759', text: 'ONLINE', class: 'bg-green' };
            if (status === 'Offline') return { color: '#ff3b30', text: 'LOGGED OUT', class: 'bg-red' };
            return { color: '#ffcc00', text: 'OFF/ERROR', class: 'bg-yellow' };
        };

        // Renders View 1
        function renderMyBotsView() {
            switchView('myBotsView');
            fetchBotsList();
        }

        // Renders View 2
        function renderManagementView(bot) {
            currentBot = bot;
            const data = getStatusData(bot.status);
            
            document.getElementById('managementBotName').textContent = bot.name;
            document.getElementById('managementBotStatus').innerHTML = `
                Status: <span class="status-tag ${data.class}">${data.text}</span> | Expiration: ${formatExpiration(bot.expirationDate)}
            `;

            const container = document.getElementById('actionButtonsContainer');
            container.innerHTML = `
                <div class="action-row">
                    <button class="action-btn" onclick="handleBotAction('restart', '${bot.name}')">Restart</button>
                    <button class="action-btn" onclick="handleBotAction('redeploy', '${bot.name}')">Redeploy</button>
                    <button class="action-btn" onclick="handleBotAction('logs', '${bot.name}')">View Logs</button>
                </div>
                <button class="action-btn" onclick="renderView('variablesView')">Set Variables</button>
                <button class="action-btn danger-button" onclick="handleBotAction('delete', '${bot.name}')">Delete Bot</button>
            `;
            switchView('managementView');
        }
        
        // Renders View 3
        function renderVariablesView() {
            document.getElementById('variablesBotName').textContent = `${currentBot.name} Variables`;
            switchView('variablesView');
            fetchAndDisplayVariables(currentBot.name);
        }

        // --- API & Core Functions ---
        
        async function fetchBotsList() {
            const container = document.getElementById('botsListContainer');
            container.innerHTML = `<div id="loadingIndicator" class="loading-text"><div class="loading"></div> Fetching active bots...</div>`;

            try {
                const data = await apiCall('/api/bots');
                
                container.innerHTML = '';
                if (data && data.bots && data.bots.length > 0) {
                    data.bots.forEach(bot => {
                        const statusData = getStatusData(bot.status);
                        
                        const card = document.createElement('div');
                        card.className = 'bot-card';
                        card.onclick = () => renderManagementView(bot);

                        card.innerHTML = `
                            <div class="bot-icon-circle" style="background-color: ${statusData.color};">${bot.appName.charAt(0).toUpperCase()}</div>
                            <div class="bot-details">
                                <div class="bot-name">${bot.appName} (${bot.type.toUpperCase()})</div>
                                <div class="bot-status">
                                    <span class="status-tag ${statusData.class}">${statusData.text}</span>
                                </div>
                            </div>
                            <div class="bot-expiration">
                                <div class="expiration-time">${formatExpiration(bot.expirationDate)}</div>
                            </div>
                        `;
                        container.appendChild(card);
                    });
                } else {
                     document.getElementById('emptyState').style.display = 'block';
                }
            } catch (e) {
                container.innerHTML = `<div class="info-box icon-color-red">Error loading bots. Check console.</div>`;
            }
        }
        
        async function fetchAndDisplayVariables(appName) {
            const container = document.getElementById('variablesListContainer');
            container.innerHTML = '<div class="loading-text">Fetching settings...</div>';

            try {
                const data = await apiCall(`/api/bots/config-vars/${appName}`);
                let html = '';
                
                if (data && data.configVars) {
                    Object.entries(data.configVars).forEach(([key, value]) => {
                        const displayValue = formatVarDisplay(value);
                        
                        html += `
                            <div class="management-option variable-item" onclick="openInputModal('${appName}', '${key}', '${value}', '${data.botType}')">
                                <div>
                                    <div class="variable-name">${key}</div>
                                    <div class="variable-value">${displayValue}</div>
                                </div>
                                <div class="variable-edit-icon">✎</div>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="info-box icon-color-red">No configuration variables found.</div>';
                }
            } catch (e) {
                container.innerHTML = `<div class="info-box icon-color-red">Error: ${e.message}</div>`;
            }
        }

        async function handleBotAction(action, appName) {
            const endpointMap = {
                'restart': 'bots/restart',
                'redeploy': 'bots/redeploy',
                'delete': 'bots/delete',
                'logs': `bots/logs/${appName}`
            };
            
            // Handle Logs (GET request, opens modal)
            if (action === 'logs') {
                showProgress(true);
                try {
                    const data = await apiCall(endpointMap[action], 'GET');
                    showProgress(false);
                    document.getElementById('logsContainer').innerHTML = data.logs 
                        .split('\n')
                        .map(log => `<div class="log-line">${escapeHtml(log)}</div>`)
                        .join('');
                    openModal('logsModal');
                } catch (e) {
                    showProgress(false);
                    showAlert(`Failed to fetch logs: ${e.message}`);
                }
                return;
            }

            // Handle POST actions (Restart, Redeploy, Delete)
            const isDestructive = action === 'delete';
            
            showConfirm(`Are you sure you want to ${action} ${appName}?`, async () => {
                showProgress(true);
                try {
                    const data = await apiCall(endpointMap[action], 'POST', { appName });
                    showProgress(false);
                    
                    if (!data.success) throw new Error(data.message);

                    showAlert(`${appName} ${action} initiated successfully!`);
                    
                    // After action, refresh the list after a delay
                    setTimeout(() => fetchBotsList(), 5000); 
                    
                } catch (e) {
                    showProgress(false);
                    showAlert(e.message || `Failed to perform ${action} on ${appName}.`);
                }
            }, isDestructive);
        }

        // --- Variable Input & Submission ---
        
        function openInputModal(appName, varName, varValue, botType) {
            // Set current state for submission
            currentVariable = { appName, varName, value: varValue, botType };
            
            document.getElementById('inputModalTitle').textContent = `Edit ${varName}`;
            document.getElementById('inputVarLabel').textContent = `${varName} for ${appName} (${botType.toUpperCase()})`;
            document.getElementById('inputVariableValue').value = varValue;
            document.getElementById('inputError').style.display = 'none';

            openModal('inputVariableModal');
        }

        window.submitVariableChange = async function() {
            const { appName, varName, botType } = currentVariable;
            const newValue = document.getElementById('inputVariableValue').value.trim();
            const errorEl = document.getElementById('inputError');

            // 1. Validation Logic
            if (varName === 'SESSION_ID') {
                let prefix = '';
                if (botType === 'levanter') prefix = 'levanter_';
                else if (botType === 'raganork') prefix = 'RGNK';
                else if (botType === 'hermit') prefix = 'H';
                
                const isValid = newValue.startsWith(prefix) && newValue.length > 10;
                if (!isValid) {
                    errorEl.textContent = `Invalid. Must start with '${prefix}' and be > 10 chars.`;
                    errorEl.classList.add('show');
                    return;
                }
            }

            errorEl.classList.remove('show');
            showProgress(true);

            // 2. API Call
            try {
                const data = await apiCall('/api/bots/set-var', 'POST', { appName, varName, varValue: newValue });
                showProgress(false);

                if (!data.success) throw new Error(data.message);

                showAlert('Variable updated successfully. Bot is restarting...');
                
                // 3. Close modals and update the list
                closeModal('inputVariableModal');
                closeModal('variablesModal');
                setTimeout(() => fetchBotsList(), 1000); // Quick refresh to show new state

            } catch (e) {
                showProgress(false);
                showAlert(e.message || 'An error occurred while updating the variable.');
            }
        };

        // --- Utilities ---
        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
        
        function formatVarDisplay(val) {
            if (val === 'false' || val === 'no-dl' || !val) return 'Disabled/Off';
            if (val === 'true' || val === 'p') return 'Enabled/Set';
            return val.substring(0, 30) + (val.length > 30 ? '...' : '');
        }


        // --- Event Listeners ---
        document.getElementById('headerBack').addEventListener('click', () => {
            if (document.getElementById('variablesView').classList.contains('active')) {
                renderManagementView(currentBot);
            } else {
                renderMyBotsView();
            }
        });
        
        // Initial Load
        window.addEventListener('load', () => {
            // Check if the current environment is set in the main bot.js file
            if (window.location.origin.includes('deploy-bot')) {
                 // Set the API base url to the correct origin if running on Render
                 apiBaseUrl = window.location.origin + '/api';
            }
            fetchBotsList();
            setInterval(fetchBotsList, 30000); // Refresh bot list every 30 seconds
        });
    </script>
</body>
</html>
